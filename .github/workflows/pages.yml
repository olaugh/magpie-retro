name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install Homebrew and m68k-elf toolchain for building ROMs
      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          echo "/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH

      - name: Install m68k-elf toolchain via Homebrew
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap rosco-m68k/toolchain
          brew install rosco-m68k/toolchain/binutils-cross-m68k
          brew install rosco-m68k/toolchain/gcc-cross-m68k@13

      - name: Build hybrid ROMs
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          make nwl23-hybrid csw24-hybrid

      - name: Copy CI-built ROMs to docs
        run: |
          cp out/scrabble-nwl23-hybrid.bin docs/play/roms/nwl23-hybrid-ci.bin
          cp out/scrabble-csw24-hybrid.bin docs/play/roms/csw24-hybrid-ci.bin

      - name: Inject build timestamps into index.html
        run: |
          # Get dates in YYMMDD format
          CI_DATE=$(date +%y%m%d)
          LOCAL_DATE=$(git log -1 --format="%ci" -- docs/play/roms/nwl23-hybrid.bin | cut -d' ' -f1 | sed 's/^20//' | tr -d '-')
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M UTC")

          # Update ROM config in emulator.js
          cat > docs/emulator.js << 'EMULATOR_EOF'
// ROM configuration - hybrid algorithm ROMs
// Local ROMs: built with GCC 15 on macOS ARM
// CI ROMs: built with GCC 13 on Linux x86_64
const ROMS = {
    'nwl23-local': { name: 'NWL23 (GCC15 LOCAL_DATE)', file: 'play/roms/nwl23-hybrid.bin' },
    'nwl23-ci': { name: 'NWL23 (GCC13 CI_DATE)', file: 'play/roms/nwl23-hybrid-ci.bin' },
    'csw24-local': { name: 'CSW24 (GCC15 LOCAL_DATE)', file: 'play/roms/csw24-hybrid.bin' },
    'csw24-ci': { name: 'CSW24 (GCC13 CI_DATE)', file: 'play/roms/csw24-hybrid-ci.bin' }
};

// Constants
const TURBO_FAST_FORWARD_RATIO = 100;

// State
let turboEnabled = false;
let fpsInterval = null;

// Get ROM from URL or default
function getSelectedRom() {
    const params = new URLSearchParams(window.location.search);
    const rom = params.get('rom');
    return (rom && ROMS[rom]) ? rom : 'nwl23-local';
}

document.addEventListener('DOMContentLoaded', function() {
    const romSelect = document.getElementById('rom-select');
    const loadBtn = document.getElementById('load-btn');
    const turboBtn = document.getElementById('turbo-btn');
    const selectedRom = getSelectedRom();

    romSelect.value = selectedRom;

    // Load button
    loadBtn.addEventListener('click', function() {
        const newRom = romSelect.value;
        const currentRom = getSelectedRom();
        if (newRom !== currentRom || !window.EJS_emulator) {
            window.location.href = '?rom=' + newRom;
        }
    });

    // Turbo toggle
    function toggleTurbo() {
        turboEnabled = !turboEnabled;
        turboBtn.textContent = turboEnabled ? 'Turbo: ON' : 'Turbo: OFF';
        turboBtn.classList.toggle('active', turboEnabled);
        if (window.EJS_emulator && window.EJS_emulator.gameManager) {
            if (turboEnabled) {
                window.EJS_emulator.gameManager.setFastForwardRatio(TURBO_FAST_FORWARD_RATIO);
                window.EJS_emulator.gameManager.toggleFastForward(1);
            } else {
                window.EJS_emulator.gameManager.setFastForwardRatio(1);
                window.EJS_emulator.gameManager.toggleFastForward(0);
            }
        }
    }

    turboBtn.addEventListener('click', toggleTurbo);

    document.addEventListener('keydown', function(e) {
        if (e.code === 'Space' && e.target === document.body) {
            e.preventDefault();
            toggleTurbo();
        }
    });

    // Load emulator
    loadEmulator(selectedRom);

    // FPS counter
    const fpsDisplay = document.getElementById('fps-display');
    let lastFrameNum = 0;
    let lastTime = performance.now();

    fpsInterval = setInterval(function() {
        if (window.EJS_emulator && window.EJS_emulator.gameManager &&
            typeof window.EJS_emulator.gameManager.getFrameNum === 'function') {
            try {
                const frameNum = window.EJS_emulator.gameManager.getFrameNum();
                const now = performance.now();
                const elapsed = (now - lastTime) / 1000;
                if (elapsed >= 0.5 && lastFrameNum > 0) {
                    const fps = (frameNum - lastFrameNum) / elapsed;
                    fpsDisplay.textContent = 'FPS ' + Math.round(fps);
                }
                lastFrameNum = frameNum;
                lastTime = now;
            } catch (e) {}
        }
    }, 500);
});

function loadEmulator(romKey) {
    const rom = ROMS[romKey];
    if (!rom) return;

    // Resolve ROM path relative to current page URL for GitHub Pages compatibility
    const romUrl = new URL(rom.file, window.location.href).href;

    window.EJS_player = '#game';
    window.EJS_core = 'genesis_plus_gx';
    window.EJS_gameUrl = romUrl;
    window.EJS_gameName = rom.name;
    window.EJS_color = '#22C55E';
    window.EJS_startOnLoaded = true;
    window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';

    const script = document.createElement('script');
    script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
    script.integrity = 'sha384-CwARP2ej7UlPGk5E0IPt89lxjdb3t7zStyLR6PL7Sg4xzHSrvXh/R4vbb4PrSv6U';
    script.crossOrigin = 'anonymous';
    document.body.appendChild(script);
}
EMULATOR_EOF

          # Replace date placeholders in emulator.js
          sed -i "s/LOCAL_DATE/${LOCAL_DATE}/g" docs/emulator.js
          sed -i "s/CI_DATE/${CI_DATE}/g" docs/emulator.js

          # Update dropdown in index.html
          sed -i 's|<option value="nwl23" selected>NWL23 (North American)</option>|<option value="nwl23-local" selected>NWL23 (GCC15 '"${LOCAL_DATE}"')</option>\n                    <option value="nwl23-ci">NWL23 (GCC13 '"${CI_DATE}"')</option>|' docs/index.html
          sed -i 's|<option value="csw24">CSW24 (International)</option>|<option value="csw24-local">CSW24 (GCC15 '"${LOCAL_DATE}"')</option>\n                    <option value="csw24-ci">CSW24 (GCC13 '"${CI_DATE}"')</option>|' docs/index.html

          # Add build timestamp to footer
          sed -i 's|<p class="author">By John O'"'"'Laughlin</p>|<p class="author">By John O'"'"'Laughlin</p>\n            <p class="build-time" style="font-size: 0.75rem; color: var(--text-label); margin-top: 8px;">Page built: '"${BUILD_TIME}"'</p>|' docs/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
